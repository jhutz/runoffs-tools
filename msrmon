#!/usr/bin/env python3

import os
import sys
import itertools
import argparse
import configparser
import requests

# These command-line options can be set in the config file
opts_from_config = ('server', 'userid', 'password', 'pwfile',
            'org-id', 'event-id', 'segment-id')

# Default values for some options.
# Only needed for options that appear in opts_from_config
opts_defaults = { 'server' : 'api.motorsportreg.com' }

# Required options for anything that connects to MSR
opts_msr_reqd = ('server', 'userid', 'password', 'org-id' )

def load_config(opts):
    """Load the config file, if any, and provide default values for options."""

    global config
    config = {}
    if opts.config is None:
        if 'HOME' in os.environ:
            def_cfg = os.path.join(os.environ['HOME'], '.msrmon')
        else:
            def_cfg = '.msrmon'
        if os.path.exists(def_cfg):
            opts.config = def_cfg
    if opts.config is not None:
        cp = configparser.ConfigParser()
        with open(opts.config) as lines:
            cp.read_file(itertools.chain(("[top]",), lines))
        config = cp['top']

    for key in opts_from_config:
        okey = key.replace('-','_')
        if key in config and getattr(opts, okey, None) is None:
            setattr(opts, okey, config[key])
    for key in opts_defaults.keys():
        if getattr(opts, key, None) is None:
            setattr(opts, key, opts_defaults[key])
    if opts.password is None and opts.pwfile is not None:
        with open(opts.pwfile) as pwfile:
            opts.password = pwfile.readline()

def msr_session(opts):
    global g_msr_session
    if 'g_msr_session' not in globals():
        g_msr_session = requests.Session()
        g_msr_session.auth = (opts.userid, opts.password)
        g_msr_session.headers.update({ 'X-Organization-Id' : opts.org_id })
    return g_msr_session

def msr_get(opts, query, params={}):
    sess = msr_session(opts)
    r = sess.get('https://%s/rest/%s.json' % (opts.server, query), params = params)
    r.raise_for_status()
    return r.json()

def do_list_events(opts):
    j = msr_get(opts, 'calendars/organization/%s' % opts.org_id,
            params = { 'archive' : 'true' } if opts.archive else {})
    if opts.debug: print(j, file=sys.stderr)
    print('%-35s  %s' % ('Event ID', 'Name'))
    for event in j['response']['events']:
        print('%-35s  %s' % (event['id'], event['name']))

def do_list_segments(opts):
    j = msr_get(opts, 'events/%s/segments' % opts.event_id)
    if opts.debug: print(j, file=sys.stderr)
    print('%-35s  %s' % ('Segment ID', 'Name'))
    for seg in j['response']['segments']:
        print('%-35s  %s' % (seg['id'], seg['name']))
        if opts.verbose:
            class_map = { x['id'] : x['shortName'] for x in seg['classes'] }
            for grp in sorted(seg['groups'], key=lambda x: x['shortName']):
                classes = [ class_map[x['classId']]
                        for x in seg['classToGroupMaps'] if x['groupId'] == grp['id'] ]
                if len(classes) > 0:
                    print('    ', grp['shortName'], '('+', '.join(sorted(classes))+')')
                else:
                    print('    ', grp['shortName'])

def do_dump_assigns(opts):
    # XXX No support for profile_questions yet 9/2/2018
    #fields = 'profile,profile_questions,modifications,vehicle_questions'
    fields = 'profile,modifications,vehicle_questions'

    if opts.items is not None and len(opts.items) > 0:
        # XXX No support for individual assignment fetch yet 9/2/2018
        for item in opts.items:
            j = msr_get(opts, 'events/%s/assignments/%s' %
                    (opts.event_id, auid), params = { 'fields' : fields })
            print(j)
    else:
        j = msr_get(opts, 'events/%s/segments/%s/assignments' %
                (opts.event_id, opts.segment_id), params = { 'fields' : fields })
        print(j)

def do_dump_changes(opts):
    if opts.items is not None and len(opts.items) > 0:
        for item in opts.items:
            j = msr_get(opts, 'events/%s/feeds/timing/%s' % (opts.event_id, item))
            print(j)
    else:
        j = msr_get(opts, 'events/%s/feeds/timing' % opts.event_id,
                params = { 'segment' : opts.segment_id })
        print(j)

def do_help(opts, ap):
    if (opts.subcommand is not None):
        ap.parse_args([opts.subcommand, '--help'])
    else:
        ap.print_help()
    ap.exit()

def process_args():
    ap = argparse.ArgumentParser(usage='%(prog)s [options] command [args...]')
    sp = ap.add_subparsers(title='subcommands', metavar=None)
    ap._optionals.title = 'Options'
    
    ap.add_argument('-d', '--debug', action='store_true',
            help='Enable debugging')
    ap.add_argument('-v', '--verbose', action='store_true',
            help='Enable verbose output')
    ap.add_argument('-c', '--config',     help='Config file')
    ap.add_argument('--server', help='MotorsportReg API server')
    ap.add_argument('-U', '--userid',     help='MotorsportReg username')
    ap.add_argument('-P', '--password',   help='MotorsportReg password')
    ap.add_argument(      '--pwfile',     help='File containing MotorsportReg password')
    ap.add_argument('-O', '--org-id',     help='Organization ID')
    ap.add_argument('-E', '--event-id',   help='Event ID')
    ap.add_argument('-S', '--segment-id', help='Segment ID')

    p = sp.add_parser('help', help='Show help message or subcommand help')
    p.add_argument('subcommand', nargs='?', help='Subcommand to show help for')
    p.set_defaults(_func = do_help)
    p.set_defaults(_args = (ap,))

    p = sp.add_parser('list_events', help='List available events from MSR')
    p.add_argument('--archive', action='store_true', help='Show old events')
    p.set_defaults(_func = do_list_events)
    p.set_defaults(_required = opts_msr_reqd)

    p = sp.add_parser('list_segments', help='List event segments')
    p.set_defaults(_func = do_list_segments)
    p.set_defaults(_required = opts_msr_reqd + ('event-id',))

    p = sp.add_parser('dump_assigns', help='Dump raw assignment data')
    p.add_argument('items', nargs=argparse.REMAINDER, help='Assignment IDs to dump')
    p.set_defaults(_func = do_dump_assigns)
    p.set_defaults(_required = opts_msr_reqd + ('event-id',))

    p = sp.add_parser('dump_changes', help='Dump raw change data')
    p.add_argument('items', nargs=argparse.REMAINDER, help='Change IDs to dump')
    p.set_defaults(_func = do_dump_changes)
    p.set_defaults(_required = opts_msr_reqd + ('event-id','segment-id'))

    opts = ap.parse_args()
    if not hasattr(opts, '_func'):
        ap.error('Missing subcommand')
    load_config(opts)

    required = set(getattr(opts, '_required', ()))
    missing = [ x for x in required if getattr(opts, x.replace('-', '_'), None) is None ]
    if len(missing) > 0:
        for x in missing: sys.stderr.write("--%s is required\n" % x)
        ap.print_usage(file=sys.stderr)
        ap.exit(status=2)

    opts._func(opts, *getattr(opts, '_args', ()))

process_args()
